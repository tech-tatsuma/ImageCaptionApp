# FastAPIを用いたWebRTC配信サーバー構築
## 利用方法
Docker環境を立ち上げる
```
docker-compose build
```
```
docker-compose up -d
```
Docker環境が立ち上がったのち http://localhost:8080 にアクセスし、UIに従って操作を行う。ただし、この時、ブラウザに適切にカメラやマイクの権限を付与していることが起動するための条件となる。
bashに入るためには以下のコマンドを実行．
```
docker container exec -it fastapi-webrtc-restapi-1 bash
```

## memo
Docker環境の立ち上げ時に$PWDの環境変数を参照するがこの環境変数がセットされていないという警告が出る場合がある。その場合はプログジェクト内でpwdコマンドを実行して
```
PWD=/home/jetson/Desktop/fastapi-webrtc docker-compose up --build
```
のようなコマンドを利用し、環境の立ち上げを行う。
## フロントエンド
WebRTCを使用したリアルタイムのオーディオおよびビデオ通信を実現するためのJavaScriptsコードをapp/static/client.jsに用意している。ブラウザ間での直接的なメディアストリームの共有を可能にし、データチャネルを通じてメッセージの送受信も行う。
※python ver.はapp/another_client/another_client.pyに用意している．このプログラムを利用することでpython - python間のwebrtc通信が可能となる．（実行確認未）
### 機能
- メディアデバイス（カメラ、マイク）の検出と使用
- STUNサーバーを介したNATトラバーサル
- オーディオとビデオのストリームトラックの追加と交換
- SDP(Session Description Protocol)に基づくオファー・アンサーの交換
- データチャネルを使用したテキストベースのメッセージング
- ピアコネクションの状態変化のロギング

## バックエンド
PythonのFastAPIとWebRTCを使用してリアルタイムのオーディオおよびビデオ通信を実現するサーバーサイドの実装である。WebRTCのピアコネクションを管理しクライアント間でのメディアストリームの共有を可能にする。
### 主要機能
- FastAPIを使用したWebサーバーのセットアップ
- WebRTCのピアコネクションの管理
- SDP(Session Description Protocol)に基づくオファー・アンサーの処理
- メディアストリームの変換（エッジ検出などのビデオエフェクト）
- データチャネルを通じたメッセージングのサポート
- ヘルスチェックエンドポイントの提供
### エンドポイント
- '/': ルートページを提供する。HTMLレンダリングに使用される。
- '/health': ヘルスチェック用のエンドポイント。サーバーが正常に動作しているかを確認する。
- '/offer': WebRTCのオファーを受け取り、アンサーを生成して返すAPIエンドポイント。
- '/message' : データチャネルを通じてメッセージを送信するAPIエンドポイント。

## WebRTCとは？
WebRTCとは、「Web Real-Time Communication」の略称で、APIを経由して、Webブラウザやモバイルアプリでリアルタイム通信を可能にするためのオープンソースプロジェクトである。この技術は、音声通話、ビデオ通話、ファイル共有など、リアルタイムでのデータ交換をサポートする。WebRTCは、プラグインや外部ソフトウェアに頼ることなく、ブラウザ間で直接通信を行うことができるため、ユーザー体験を大幅に改善する。

WebRTCの重要な特徴の一つが、P2P（Peer-to-Peer）通信である。P2P通信は、サーバーを介さずに端末同士が直接接続し、データを交換する方式である。これにより、通信の遅延が少なくなり、効率的なデータ転送が可能になる。また、サーバーを介さないため、サーバーにかかる負荷も軽減される。P2P通信では、各端末は「ピア」として機能し、相互にデータを送受信する。この方式は、ユーザー間の直接的な通信に最適であり、特にビデオチャットやオンラインゲーム、ファイル共有サービスなどで利用されている。

WebRTCは、セキュリティも重視されており、通信内容はエンドツーエンドで暗号化される。これにより、中間者によるデータの盗聴や改ざんを防ぐことが可能となる。

WebRTCは、ブラウザベースであるため、特定のプラットフォームやデバイスに依存することなく、幅広いユーザーにアクセス可能である。これにより、様々なデバイスやオペレーティングシステム間での互換性が保たれ、より多くの人々が簡単にリアルタイム通信を楽しむことができる。

総じて、WebRTCは、リアルタイム通信を簡単かつ安全に行うための強力なツールであり、その柔軟性と汎用性により、多くのアプリケーションでの利用が進んでいる。開発者は、WebRTCを用いることで、コスト効率が良く、高品質な通信機能をアプリケーションに迅速に統合することができる。

また、WebRTCのもう一つの鍵となる技術は、STUN（Session Traversal Utilities for NAT）とTURN（Traversal Using Relays around NAT）である。これらはNAT（ネットワークアドレス変換）の背後にあるデバイス間での通信を容易にするためのプロトコルであり、P2P通信をサポートする。STUNは、NATの背後にあるデバイスの公開IPアドレスを検出するのに使用され、TURNはNATやファイアウォールの制約を越えて通信するためにリレーサーバーを提供する。

これらの技術により、WebRTCは幅広いネットワーク環境で安定した通信を実現し、リアルタイム通信の新たな可能性を開いている。ビジネス、教育、エンターテイメントなど、多岐にわたる分野での利用が期待されている。

本レポジトリでは、上記のようなWebRTCサーバーをFastAPIを用いて構築するためのコードとドキュメントを提供する

## SDPとは？
SDPとは、インターネットプロトコルを使用したマルチメディアセッションの設定情報を記述するためのプロトコルである。SDP自体はメディアを送受信するためのメカニズムを提供するわけではなく、セッションの記述とアナウンスのための「フォーマット」を提供する。
SDPを使用する、以下のような情報を伝達できる。
- セッション名と目的
- セッションが有効な時間帯
- 使用するメディアの種類（オーディオ、ビデオなど）
- メディアを伝送するための通信プロトコル
- メディアストリームを伝送するためのIPアドレスやポート番号
- コーデックの情報やその他のメディアフォーマットの詳細
WebRTCなどのリアルタイム通信では、通信を始める前に両端店間でSDPを交換することで、どのような種類のメディアをどのように交換するかを合意する。SDPはテキストベースのフォーマットで記述され、オファー・アンサーモデルに基づいて一方のピアからもう一方のピアへ送信される。

例えば、あるピアがビデオとオーディオのストリームを提供したい場合、その情報を含むSDPを生成し、もう一方のピアに送信する。受信したピアはこのSDPを解析し、対応するメディアの種類を理解し、適切な応答（アンサーSDP）を生成して返信する。

簡単に言うと、SDPは通信の「目録」のようなもので、どのようなメディアが交換されるか、どのように交換されるかを定義するために使用される。

## STUNサーバー
STUN（Session Traversal Utilities for NAT）サーバーは、NAT（Network Address Translation）を使用してインターネットに接続しているデバイスが、自身の公開IPアドレスとポート番号を知るために使用されるサーバー。特に、リアルタイム通信を行う際に、ピア間で直接通信を確立するために重要な役割を果たす。
### NATとは
NATは、多くのホームネットワークや企業ネットワークで一般的に使用される技術である。NATは、ネットワーク内の複数のプライベートIPアドレスを、単一の公開IPアドレスにマッピングする。これにより、内部ネットワークのデバイスがインターネット上で通信できるようになる。
### STUNサーバーの役割
STUNサーバーの主な役割は、NAT背後にあるデバイスが、自身の公開IPアドレスとポート番号を知るための手段を提供することである。デバイスはSTUNサーバーにリクエストを送信し、STUNサーバーはデバイスに対してその公開IPアドレスとポート番号を含む応答を返す。
### WebRTCとSTUNサーバー
WebRTCなどのピアツーピア通信技術では、ピア間で直接メディアストリームを交換するために、各ピアの公開IPアドレスとポート番号が必要である。STUNサーバーを使用することで、ピアは自身の公開IPアドレスとポート番号を知り、それを相手方のピアに通知することができる。これにより、NATを越えた直接的なピアツーピア通信が可能になる。
## データチャネルとは？
チャネルとは，コミュニケーションや情報技術の分野において，データや情報が伝達される経路や媒体を指す用語である．データチャネルとは，WebRTCの機能の一つでブラウザ間の接続を通じて任意のデータを直接やりとりするためのチャネル（経路）である．データチャネルを使うことで，テキスト，ファイル，その他のバイナリデータなど，様々な種類のデータを高速化つセキュアに変換することが可能である．
